<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>DCG Planner 2026 ‚Äì St Peter‚Äôs</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#f5f7fb; --card:#fff; --ink:#111; --muted:#6b7280;
  --accent:#2563eb; --accentDark:#1e40af;
  --grid:#e5e7eb; --line:#d1d5db; --head:#f8fafc;
}
*{box-sizing:border-box}
body{margin:0;padding:20px;background:var(--bg);color:var(--ink);font-family:Helvetica,Arial,sans-serif;}
.wrap{max-width:;margin:0 auto}
.card {
  background: var(--card);
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  margin: 0 auto 16px auto;  /* centers the card */
  width: 90vw;               /* 90% of the viewport width */
  max-width: none;           /* remove parent width limit */
}


h2{margin:0 0 8px 0;font-size:22px}
button,input,select{font-family:inherit}
input[type=text],input[type=date],input[type=number],select,button{
  width:100%;padding:10px 12px;font-size:18px;
  border:1px solid var(--grid);border-radius:12px;background:#fff;
}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
button:hover{background:var(--accentDark)}

/* ===== SUBJECT GRID ===== */
.subject-grid {
  display: grid;
  grid-template-columns: repeat(9, 100px); /* fixed width columns */
  gap: 8px;
  margin-top: 10px;
  justify-content: start;
}
.subject-box {
  width: 100px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 16px;
}
.subject-box input {
  background: transparent;
  border: none;
  text-align: center;
  font-weight: 600;
  font-size: 16px;
  width: 90%;
  color: #000;
}

/* ===== GRID + TABLES ===== */
.grid-preview {
  overflow: auto;
  border: 1px solid var(--grid);
  border-radius: 12px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 16px;
  table-layout: fixed; /* lock widths */
}
th,
td {
  border: 1px solid var(--line);
  padding: 8px;
  vertical-align: top;
  text-align: center;
  width: 11.11%; /* consistent width across columns */
  word-wrap: break-word;
}
th{background:#f8fafc;text-align:center}

/* ===== TERM CONTROLS ===== */
.term-toggle{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.term-toggle label{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--grid);background:#fff;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.05);}
.term-toggle input{transform:scale(1.2)}
.controls-terms{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
.term-card{border:1px solid var(--grid);border-radius:10px;padding:8px;background:#fff;}
.term-card>div{font-weight:700;margin-bottom:6px;font-size:14px}
label{font-size:12px;color:#374151;display:block;margin:6px 0 4px}
input[type="date"],input[type="number"]{padding:8px 10px;font-size:16px;border-radius:10px}

/* ===== PAGE STYLING ===== */
.page {
  width: 210mm;
  min-height: 297mm;
  background: #fff;
  color: #000;
  margin: 0 auto 12px auto;
  padding: 10mm 0 0 0;   /* top right bottom left */
  page-break-after: always;
  position: relative;
}
/* ===== PAGE HEADERS ===== */
.pg-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  padding-bottom: 5mm;
  margin-bottom: 5mm;
}

/* Remove border for Weekend‚ÄìTue (right-bind) pages */
.page.right-bind .pg-header {
  border-bottom: none;
}

/* Keep border for Wed‚ÄìFri (left-bind) pages */
.page.left-bind .pg-header {
  border-bottom: 2px solid #000;
}

.pg-header-spacer {
  height: 25mm;
}

.pg-left h3{margin:0;font-size:20px}
.week-grid th{
  border:1px solid #000;
  padding:4mm;               /* keep header padding */
  text-align:center;
  width:20%;
}

.week-grid td{
  border:1px solid #000;
  padding:0;                 /* remove padding so content can hit the edge */
  vertical-align:top;
  text-align:left;
  width:20%;
  position:relative;         /* for absolute child */
}
.slot{
  position:relative;
  min-height:40mm;
   overflow: hidden;   /* prevent text overflow if needed */
}
.hl{
  position:absolute;
  top:0;                     /* flush against top border */
  left:0;                    /* flush against left border */
  font-weight:700;
  font-size:17px;
  line-height:1.1;
  border-radius:3px;
  max-width:100%;
  word-wrap:break-word;
  display:inline-block;
  text-align:left;
  /* optional breathing room:
  padding:1.5mm 2mm; top:0; left:0; */
}

.divider{height:6mm;background:#f2f3f6;border:none}
.cover{position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
.cover h1{font-size:72px;margin:0;font-weight:700}
.cover h2{font-size:32px;margin:10px 0 20px 0;font-weight:500}
.cover img{width:120mm;max-width:90%;height:auto;margin-top:10mm}
.event-label{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#eceff3;color:#555;font-style:italic;text-align:center;border-radius:2px;}
.summary-table{border-collapse:collapse;width:100%;margin-top:20px;table-layout:fixed;}
.summary-table th,.summary-table td{border:1px solid #000;padding:6px;text-align:center;font-size:14px;word-wrap:break-word;}
.summary-table th{background:#f2f2f2}
@media print{
  body{background:#fff;padding:0}
  .card,.no-print{display:none!important}
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
  @page{size:A4 portrait;margin:8mm}
}
</style>

</head>
<body>
<div class="wrap">

  <div class="card">
    <h2>7 Day Timetable Planner Generator</h2>

<div id="scWrap" style="display:flex;flex-direction:column;gap:25px;">
  <!-- Subjects & Classrooms -->
  <div id="subjectsTable"></div>

  <!-- Timetable (with DUTY toggles) -->
  <div id="gridWrap" class="grid-preview"></div>
</div>

  </div>

<div class="card">
  <h2>Events & Holidays</h2>
  <table id="eventsTable" style="width:100%; border-collapse:collapse; table-layout:fixed;">
    <thead>
      <tr>
        <th style="width:30%;">Event</th>
        <th style="width:20%;">Date</th>
        <th style="width:40%;">Periods</th>
        <th style="width:10%;">Delete</th>
      </tr>
    </thead>
    <tbody id="eventsBody"></tbody>
    <tfoot>
      <tr>
        <td colspan="4" style="text-align:left; padding:10px;">
          <button id="addEventBtn">‚ûï Add Event</button>
        </td>
      </tr>
    </tfoot>
  </table>
</div>


<div class="card">
  <h2>Print Options</h2>
  <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px;">
    <div id="printControls" class="term-toggle" style="flex:1; min-width:260px;"></div>
    <div style="display:flex; align-items:center; gap:10px;">
      <label for="extraPages" style="font-size:16px;">Blank note pages:</label>
      <input id="extraPages" type="number" min="0" max="50" value="4" style="width:80px; font-size:16px; padding:6px 8px; border-radius:8px;">
    </div>
  </div>
<div style="
  margin-top:15px;
  display:flex;
  justify-content:flex-end;
  align-items:left;
  gap:12px;
  flex-wrap:wrap;
">
  <button id="loadBtn" style="width:auto; min-width:160px;">üìÇ Load Planner</button>
  <button id="saveBtn" style="width:auto; min-width:160px;">üíæ Save Planner</button>
  <button id="printBtn" style="width:auto; min-width:160px;">üñ®Ô∏è Print / PDF</button>
  <input type="file" id="loadFile" accept=".csv" style="display:none;">
</div>

</div>


  <div id="pages"></div>
</div>

<script>
/* ===== BASE DATA ===== */
const PALETTE = [
  '#FFB3BA', // 1 - pink
  '#FFDFBA', // 2 - peach
  '#FFFFBA', // 3 - yellow
  '#BAFFC9', // 4 - mint
  '#BAE1FF', // 5 - sky blue
  '#E0BBFF', // 6 - lavender

  // More contrasting two-tone pastels
  'repeating-linear-gradient(135deg, #FFB3BA 0%, #FFB3BA 20%, #BAE1FF 20%, #BAE1FF 40%)', // 7 - red/blue pastel
  'repeating-linear-gradient(135deg, #BAFFC9 0%, #BAFFC9 20%, #E0BBFF 20%, #E0BBFF 40%)', // 8 - green/purple pastel
  'repeating-linear-gradient(135deg, #FFFFBA 0%, #FFFFBA 20%, #A8D0FF 20%, #A8D0FF 40%)'  // 9 - yellow/blue pastel
];

const DEFAULT_TERMS=[
 {term:1,start:'2026-02-02',weeks:9,startDay:1},
 {term:2,start:'2026-04-20',weeks:10,startDay:5},
 {term:3,start:'2026-07-20',weeks:10,startDay:2},
 {term:4,start:'2026-10-12',weeks:9,startDay:6},
];
let termConfig=JSON.parse(JSON.stringify(DEFAULT_TERMS));
let termInclude=[true,true,true,true];
let extraPages=4;

/* subjects/rooms model (9 columns) */
let subjCols=Array.from({length:9},(_,i)=>({subject:'',rooms:['']}));

/* rotation grid: store SUBJECT and ROOM separately */
let gridSub=Array.from({length:6},()=>Array(7).fill(''));
let gridRoom=Array.from({length:6},()=>Array(7).fill(''));

/* Duty text entries by rotation day (1..7) */
let dutyTextP2 = Array(7).fill('');
let dutyTextP4 = Array(7).fill('');

/* ===== FIXED HOLIDAYS (locked & always skipped) ===== */
const FIXED_EVENTS=[
 {include:true,skip:true,name:'',date:'2026-02-02',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Waitangi Day',date:'2026-02-06',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Athletics Day',date:'2026-02-25',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Leave Weekend',date:'2026-03-09',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Parent Conferences',date:'2026-04-02',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Good Friday',date:'2026-04-03',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Teacher Only Day',date:'2026-04-20',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'ANZAC Day',date:'2026-04-27',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Leave Weekend',date:'2026-05-29',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:"King's Birthday",date:'2026-06-01',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Teacher Only Day',date:'2026-07-20',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Parent Conferences',date:'2026-08-21',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Leave Weekend',date:'2026-08-24',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Leave Weekend',date:'2026-08-25',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Labour Day',date:'2026-10-26',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'Ends of Year',date:'2026-12-10',periods:[1,1,1,1,1,1]},
 {include:true,skip:true,name:'End of Year',date:'2026-12-11',periods:[1,1,1,1,1,1]},
];

/* ===== CUSTOM EVENTS (editable) ===== */
let events=[];

/* ===== UTILITIES ===== */
function allEvents(){return[...FIXED_EVENTS,...events];}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function ddm(n){return `${n.getDate()}/${n.getMonth()+1}`;}
function strip(d){const z=new Date(d);return new Date(z.getFullYear(),z.getMonth(),z.getDate());}
function sameDate(a,b){return strip(a).getTime()===strip(b).getTime();}
function isSkipped(date){return allEvents().some(ev=>ev.include&&ev.skip&&sameDate(date,ev.date));}
function deltaTeachingDaysSkipAware(s,e){s=strip(s);e=strip(e);if(e<s)return-deltaTeachingDaysSkipAware(e,s);let c=0,x=new Date(s);while(x<=e){const w=x.getDay();if(w>=1&&w<=5&&!isSkipped(x))c++;x.setDate(x.getDate()+1);}return c-1;}
function computeRotationDay(dateObj,termStart,startDay){const k=deltaTeachingDaysSkipAware(termStart,dateObj);const idx=((startDay-1)+k)%7;return((idx+7)%7)+1;}
const periods=['P1','P2','P3','P4','P5','P6'];
const days=['Day 1','Day 2','Day 3','Day 4','Day 5','Day 6','Day 7'];

/* ===== SUBJECTS MAP ===== */
let subjects={}; // {name: color}
let subjectRooms={}; // name -> rooms[]
function rebuildSubjects(){
  subjects={}; subjectRooms={};
  subjCols.forEach((col,i)=>{
    const name=(col.subject||'').trim();
    if(name){
      subjects[name]=PALETTE[i%PALETTE.length];
      const rooms=(col.rooms||[]).map(r=>r.trim()).filter(Boolean);
      subjectRooms[name]=rooms.length?rooms:[''];
    }
  });
}

/* ===== SUBJECTS & CLASSROOMS TABLE ===== */
function renderSubjectsTable(){
  const host=document.getElementById('subjectsTable');
  let rows=Math.max(...subjCols.map(c=>Math.max(1,c.rooms.length)))+1; // +1 subject row

  let html=`<table style="width:100%;border-collapse:collapse;table-layout:fixed">
  <thead><tr>`;
  for(let c=0;c<9;c++){
    html+=`<th style="border:1px solid var(--grid);padding:6px;text-align:center;background:${PALETTE[c]};">Subject ${c+1}</th>`;
  }
  html+=`</tr></thead><tbody>`;

  // subject row
  html+=`<tr>`;
  for(let c=0;c<9;c++){
    const val=subjCols[c].subject||'';
    html+=`<td style="border:1px solid var(--grid);padding:6px;background:${PALETTE[c]};">
      <input data-type="subj" data-c="${c}" value="${val}" placeholder="Subject" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;">
    </td>`;
  }
  html+=`</tr>`;

  // classroom rows
  for(let r=0;r<rows-1;r++){
    html+=`<tr>`;
    for(let c=0;c<9;c++){
      const v=subjCols[c].rooms[r]??'';
      html+=`<td style="border:1px solid var(--grid);padding:6px;">
        <input data-type="room" data-c="${c}" data-r="${r}" value="${v}" placeholder="Classroom" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;">
      </td>`;
    }
    html+=`</tr>`;
  }

  // single add-row button across all columns
  html+=`<tr><td colspan="9" style="border:1px solid var(--grid);padding:8px;text-align:center;">
    <button id="addRoomRowBtn" style="min-width:220px;">‚ûï Add Classroom Row</button>
  </td></tr>`;

  html+=`</tbody></table>`;
  host.innerHTML=html;

  // listeners
  host.querySelectorAll('input[data-type="subj"]').forEach(inp=>{
    inp.oninput=e=>{
      const c=+e.target.dataset.c;
      subjCols[c].subject=e.target.value.trim();
      rebuildSubjects(); renderGrid(); renderPages();
    };
  });
  host.querySelectorAll('input[data-type="room"]').forEach(inp=>{
    inp.oninput=e=>{
      const c=+e.target.dataset.c, r=+e.target.dataset.r;
      const v=e.target.value;
      subjCols[c].rooms[r]=v;
      while(subjCols[c].rooms.length>1 && !subjCols[c].rooms.at(-1).trim()) subjCols[c].rooms.pop();
      rebuildSubjects(); renderGrid(); renderPages();
    };
  });
  host.querySelector('#addRoomRowBtn').onclick=()=>{
    subjCols.forEach(col=>col.rooms.push(''));
    renderSubjectsTable();
  };
}

/* ===== ROTATION GRID with DUTY CHECKBOXES ===== */
function renderGrid() {
  const host = document.getElementById('gridWrap');
  let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Period\\Day</th>' +
             days.map(d => `<th>${d}</th>`).join('') +
             '</tr></thead><tbody>';

  // P1, P2
  for (let r = 0; r < 2; r++) html += rowHTML(r);
  html += dutyRowHTML('Duty', dutyTextP2, 'p2');

  // P3, P4
  for (let r = 2; r < 4; r++) html += rowHTML(r);
  html += dutyRowHTML('Duty', dutyTextP4, 'p4');

  // P5, P6
  for (let r = 4; r < 6; r++) html += rowHTML(r);

  html += '</tbody></table>';
  host.innerHTML = html;

  // Subject select handlers
  host.querySelectorAll('select[data-cell]').forEach(sel => {
    const [pr, dc] = sel.dataset.cell.split(',').map(Number);
    const curSub = gridSub[pr][dc] || '';
    const curRoom = gridRoom[pr][dc] || '';
    const val = curSub ? `${curSub}|||${curRoom}` : '';
    sel.value = val;

    sel.onchange = e => {
      const [r, c] = e.target.dataset.cell.split(',').map(Number);
      const v = e.target.value;
      if (!v) { gridSub[r][c] = ''; gridRoom[r][c] = ''; }
      else {
        const [s, room] = v.split('|||');
        gridSub[r][c] = s;
        gridRoom[r][c] = room || '';
      }
      renderPages();
    };
  });

  // Duty text handlers
  host.querySelectorAll('input[data-dutytext]').forEach(inp => {
    inp.oninput = e => {
      const day = +e.target.dataset.day;
      const type = e.target.dataset.dutytext;
      if (type === 'p2') dutyTextP2[day] = e.target.value;
      else dutyTextP4[day] = e.target.value;
      renderPages();
    };
  });
}


function rowHTML(periodRow){
  rebuildSubjects();
  const names=Object.keys(subjects).sort();
  let h=`<tr><th>${periods[periodRow]}</th>`;
  for(let c=0;c<7;c++){
    let opts='<option value=""></option>';
    names.forEach(n=>{
      const rooms=subjectRooms[n]||[''];
      rooms.forEach(room=>{
        const label = room ? `${n}-${room}` : `${n}`;
        const value = `${n}|||${room}`;
        opts+=`<option value="${value}">${label}</option>`;
      });
    });
h+=`<td><select data-cell="${periodRow},${c}" style="width:100%;padding:8px;border-radius:10px;border:1px solid var(--grid);font-size:14px;">${opts}</select></td>`;
  }
  return h+'</tr>';
}

function dutyRowHTML(label, dutyArr, type) {
  let h = `<tr><td class="divider" style="text-align:center;font-weight:700;background:#f2f3f6;">${label}</td>`;
  for (let c = 0; c < 7; c++) {
    const val = dutyArr[c] || '';
    h += `<td class="divider" style="background:#f2f3f6;text-align:center;">
      <input type="text" data-dutytext="${type}" data-day="${c}"
        placeholder="Duty location"
        value="${val}"
        style="width:95%;padding:6px;border-radius:8px;border:1px solid var(--grid);font-size:14px;text-align:center;">
    </td>`;
  }
  return h + '</tr>';
}



/* ===== PAGES ===== */
function eventsAffecting(dateObj,periodIndex){
  return allEvents().filter(ev=>ev.include&&sameDate(dateObj,ev.date)&&ev.periods[periodIndex]).map(ev=>ev.name);
}

function renderPages(){
  const out=document.getElementById('pages'); out.innerHTML='';

  // Cover
  const cover=document.createElement('div');cover.className='page';
  cover.innerHTML=`<div class="cover"><h1>Name__________</h1><h2>St Peter‚Äôs Planner</h2><img src="Crest.png" alt="Crest"></div>`;
  out.appendChild(cover);

// Timetable image + copy of 7-day timetable (plain view)
const timg = document.createElement('div');
timg.className = 'page';
timg.innerHTML = `
  <div class="cover">
    <div>
      <img src="Timetable.png" alt="Timetable" style="width:204mm;max-width:95%;height:auto;margin-top:10mm;">
      <div style="margin-top:16mm;">${plainTimetableTable()}</div>
    </div>
  </div>
`;
out.appendChild(timg);


  // Summary page (with holiday list)
  const summary=document.createElement('div');summary.className='page';
// FIXED ‚Äî avoids double holidays
summary.innerHTML = generateSummaryTable();
  out.appendChild(summary);

  // Weekly pages
  termConfig.forEach((T,i)=>{
    if(!termInclude[i])return;
    const start=new Date(T.start+'T00:00:00');
    for(let w=0;w<T.weeks;w++){
      const mon=addDays(start,w*7);
      out.appendChild(buildPage(mon,start,T.startDay,T.term,w+1,true));
      out.appendChild(buildPage(mon,start,T.startDay,T.term,w+1,false));
    }
  });

  // Extra note pages
  for(let i=0;i<extraPages;i++){
    const pg=document.createElement('div');pg.className='page';
    pg.innerHTML='<div class="cover"><h2></h2></div>';
    out.appendChild(pg);
  }
}

function plainTimetableTable(){
  let html='<table class="summary-table" style="table-layout:fixed;"><thead><tr><th>Period\\Day</th>'+days.map(d=>`<th>${d}</th>`).join('')+'</tr></thead><tbody>';
  for(let r=0;r<2;r++) html+=plainRow(r);
  html+=plainDutyRow('Duty');
  for(let r=2;r<4;r++) html+=plainRow(r);
  html+=plainDutyRow('Duty');
  for(let r=4;r<6;r++) html+=plainRow(r);
  html+='</tbody></table>';
  return html;
}
function plainRow(r){
  let h=`<tr><th>${periods[r]}</th>`;
  for(let c=0;c<7;c++){
    const s=gridSub[r][c]||''; const room=gridRoom[r][c]||'';
    const show= s ? (room? `${s}-${room}` : s) : '';
    const color=s&&subjects[s]?subjects[s]:'#fff';
    h+=`<td style="padding:6px;"><div style="display:inline-block;padding:4px 6px;border-radius:4px;background:${color};">${show}</div></td>`;
  }
  return h+'</tr>';
}
function plainDutyRow(label){
  let h=`<tr><td style="background:#f2f3f6;font-weight:700;">${label}</td>`;
  for(let c=0;c<7;c++){h+=`<td style="background:#f2f3f6;"></td>`;}
  return h+'</tr>';
}

function generateEventList() {
  let html = '<h3 style="margin-top:25px;text-align:left;">Events, Public Holidays & Leave Weekends</h3>';
  html += '<ul style="list-style:none;padding:0;margin:0;font-size:14px;line-height:1.4;">';

  const weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  termConfig.forEach((T, ti) => {
    const termEvents = allEvents().filter(ev => {
      const d = new Date(ev.date);
      const start = new Date(T.start);
      const end = addDays(start, T.weeks * 7);
      return ev.include && ev.skip && d >= start && d < end;
    });

    if (termEvents.length > 0) {
      html += `<li style="margin-top:8px;font-weight:700;color:#000;font-size:15px;">Term ${T.term}</li>`;
      termEvents.forEach(ev => {
        const d = new Date(ev.date);
        const options = { day: 'numeric', month: 'short' }; // e.g. "4 Oct"
        const dateStr = d.toLocaleDateString('en-NZ', options);
        const dayName = weekdayNames[d.getDay()];

        let weekNum = '-';
        const start = new Date(T.start);
        const weekIndex = Math.floor(deltaTeachingDaysSkipAware(start, d) / 5) + 1;
        if (weekIndex > 0 && weekIndex <= T.weeks) weekNum = weekIndex;

        html += `<li style="margin-left:12px;">${ev.name} ‚Äî ${dateStr} (${dayName}, Week ${weekNum})</li>`;
      });
    }
  });

  html += '</ul>';
  return html;
}
/* ===== SUMMARY ===== */
function generateSummaryTable() {
  let html = '<h2>Class Disruption Summary</h2>';
  html += '<table class="summary-table"><tr><th>Subject</th>';
  for (let t = 1; t <= 4; t++) html += `<th>Term ${t}</th>`;
  html += '<th>Total</th></tr>';

  const allSubs = Object.keys(subjects);
  allSubs.forEach(sub => {
    let yearTotal = 0, yearPossible = 0;
    html += `<tr><td>${sub}</td>`;
    for (let ti = 0; ti < 4; ti++) {
      const T = termConfig[ti];
      if (!termInclude[ti]) { html += '<td>-</td>'; continue; }
      const start = new Date(T.start);
      let total = 0, affected = 0;
      for (let w = 0; w < T.weeks; w++) {
        for (let day = 0; day < 5; day++) {
          const current = addDays(start, w * 7 + day);
          const dayOfWeek = strip(current).getDay();
          const fullDay = allEvents().some(ev => ev.include && ev.skip && sameDate(current, ev.date));
          if (fullDay) continue;
          const rot = computeRotationDay(current, start, T.startDay);
          for (let p = 0; p < 6; p++) {
            if (gridSub[p][rot - 1] === sub) {
              total++;
              let evHit = allEvents().some(ev => ev.include && !ev.skip && sameDate(current, ev.date) && ev.periods[p]);
              if (!evHit && dayOfWeek === 5 && p === 0) evHit = true;
              if (evHit) affected++;
            }
          }
        }
      }
      yearTotal += total - affected; yearPossible += total;
      html += `<td>${(total - affected)}/${total}</td>`;
    }
    html += `<td>${yearTotal}/${yearPossible}</td></tr>`;
  });
  html += '</table>';

  // üîπ Term Dates Table (with 4 Oct-style dates)
  html += `
    <h3 style="margin-top:25px;text-align:left;">Term Dates & Length</h3>
    <table class="summary-table" style="font-size:15px;">
      <tr><th>Term</th><th>Start Date</th><th>End Date</th><th>Weeks</th></tr>
      ${termConfig.map(t => {
        const start = new Date(t.start);
        const end = addDays(start, t.weeks * 7 - 1);
        const fmt = { day: 'numeric', month: 'short' };
        const startStr = start.toLocaleDateString('en-NZ', fmt);
        const endStr = end.toLocaleDateString('en-NZ', fmt);
        return `
          <tr>
            <td>${t.term}</td>
            <td>${startStr}</td>
            <td>${endStr}</td>
            <td>${t.weeks}</td>
          </tr>`;
      }).join('')}
    </table>
  `;

  // üîπ Append formatted events list
  html += generateEventList();
  return html;
}
/* ===== WEEKLY PAGE RENDER ===== */
function buildPage(monday, termStart, startDay, termNumber, weekNumber, isFirst) {
  const page = document.createElement('div');
  page.className = 'page ' + (isFirst ? 'right-bind' : 'left-bind');

  const tbl = document.createElement('table');
  tbl.className = 'week-grid';
  const thead = document.createElement('thead');
  const hr = document.createElement('tr');

  // üîπ Columns: Page 1 = Mon‚ÄìWed, Page 2 = Thu‚ÄìFri + Weekend
  const cols = isFirst
    ? [['Mon', monday], ['Tue', addDays(monday, 1)], ['Wed', addDays(monday, 2)]]
    : [['Thu', addDays(monday, 3)], ['Fri', addDays(monday, 4)], [`Weekend (T${termNumber}-W${weekNumber})`, null]];

  // === HEADERS ===
  cols.forEach(([label, date]) => {
    const th = document.createElement('th');
    if (date) {
      const dayNum = computeRotationDay(date, termStart, startDay);
      const skipped = isSkipped(date);
      const options = { day: 'numeric', month: 'short' }; // e.g. "4 Oct"
      const dateStr = date.toLocaleDateString('en-NZ', options);

      th.textContent = `${label} ‚Äì ${dateStr} ‚Äì Day ${dayNum}`;
      if (skipped) {
        th.style.background = '#e5e7eb';
        th.style.color = '#777';
        th.style.fontStyle = 'italic';
      }
    } else {
      th.textContent = label; // weekend column
    }
    hr.appendChild(th);
  });
  thead.appendChild(hr);
  tbl.appendChild(thead);

  const tbody = document.createElement('tbody');

  // === P1, P2 ===
  for (let r = 0; r < 2; r++) tbody.appendChild(rowCells(cols, r, termStart, startDay));
  // üî∏ Duty divider after P2
  tbody.appendChild(dutyDividerRow(cols, termStart, startDay, 'p2'));

  // === P3, P4 ===
  for (let r = 2; r < 4; r++) tbody.appendChild(rowCells(cols, r, termStart, startDay));
  // üî∏ Duty divider after P4
  tbody.appendChild(dutyDividerRow(cols, termStart, startDay, 'p4'));

  // === P5, P6 ===
  for (let r = 4; r < 6; r++) tbody.appendChild(rowCells(cols, r, termStart, startDay));

  // === Notes Row ===
  const notesRow = document.createElement('tr');
  cols.forEach(() => {
    const td = document.createElement('td');
    td.style.height = '25mm';
    td.style.background = '#f9fafb';
    td.style.borderTop = '2px solid #000';
    td.style.verticalAlign = 'top';
    td.innerHTML = '<div style="padding:3mm;font-style:italic;color:#555;">Notes...</div>';
    notesRow.appendChild(td);
  });
  tbody.appendChild(notesRow);

  tbl.appendChild(tbody);
  page.appendChild(tbl);

  return page;
}

function rowCells(cols, periodIndex, termStart, startDay) {
  const tr = document.createElement('tr');
  cols.forEach(([label, date]) => {
    const td = document.createElement('td');
    const div = document.createElement('div');
    div.className = 'slot';

    if (date) {
      const skipped = isSkipped(date);
      const rot = computeRotationDay(date, termStart, startDay);
      const dayOfWeek = strip(date).getDay(); // 1=Mon ... 5=Fri

      // --- Hard rule: no Friday Period 1 ever (PD) ---
      if (dayOfWeek === 5 && periodIndex === 0) {
        const pdDiv = document.createElement('div');
        pdDiv.className = 'event-label';
        pdDiv.textContent = 'Professional Development';
        div.appendChild(pdDiv);
        td.appendChild(div);
        tr.appendChild(td);
        return; // skip to next column
      }

      if (skipped) {
        const eventsToday = allEvents()
          .filter(ev => ev.include && sameDate(date, ev.date))
          .map(ev => ev.name);
        if (eventsToday.length > 0) {
          const evDiv = document.createElement('div');
          evDiv.className = 'event-label';
          evDiv.textContent = eventsToday.join(' / ');
          div.appendChild(evDiv);
        }
      } else {
        const eventHits = eventsAffecting(date, periodIndex);
        if (eventHits.length > 0) {
          const evDiv = document.createElement('div');
          evDiv.className = 'event-label';
          evDiv.textContent = eventHits.join(' / ');
          div.appendChild(evDiv);
        } else {
          const s = gridSub[periodIndex]?.[rot - 1] || '';
          const room = gridRoom[periodIndex]?.[rot - 1] || '';
          if (s) {
            const span = document.createElement('span');
            span.className = 'hl';
            span.textContent = room ? `${s}-${room}` : s;
            if (s in subjects) span.style.background = subjects[s];
            div.appendChild(span);
          }
        }
      }
    }

    td.appendChild(div);
    tr.appendChild(td);
  });
  return tr;
}


function dutyDividerRow(cols, termStart, startDay, which) {
  const tr = document.createElement('tr');
  cols.forEach(([label, date]) => {
    const td = document.createElement('td');
    td.className = 'divider';
    td.style.background = '#f2f3f6';

    if (date && !isSkipped(date)) {
      const rotDay = computeRotationDay(date, termStart, startDay);
      const text = (which === 'p2')
        ? dutyTextP2[rotDay - 1]
        : dutyTextP4[rotDay - 1];
      if (text && text.trim() !== '') {
        const d = document.createElement('div');
        d.textContent = text;
        d.style.fontStyle = 'italic';
        d.style.color = '#333';
        d.style.textAlign = 'center';
        td.appendChild(d);
      }
    }

    tr.appendChild(td);
  });
  return tr;
}



/* ===== EVENTS TABLE ===== */
function renderEvents() {
  const tb = document.getElementById('eventsBody');
  tb.innerHTML = '';

  events.forEach((ev, i) => {
    if (!Array.isArray(ev.periods)) ev.periods = [0, 0, 0, 0, 0, 0];

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${ev.name}" data-i="${i}" data-k="name"></td>
      <td><input type="date" value="${ev.date}" data-i="${i}" data-k="date"></td>
      <td>
        <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;">
          ${[0,1,2,3,4,5].map(p => `
            <label style="font-size:12px;">
              <input class="pchk" type="checkbox" ${ev.periods[p] ? 'checked' : ''} data-i="${i}" data-p="${p}">P${p+1}
            </label>`).join('')}
        </div>
      </td>
      <td><button data-del="${i}">‚úñ</button></td>
    `;
    tb.appendChild(tr);
  });

  // --- Event handlers ---
  tb.querySelectorAll('input,button').forEach(el => {
    el.onchange = e => {
      const i = +e.target.dataset.i;
      const k = e.target.dataset.k;
      const p = e.target.dataset.p;
      if (k === 'name' || k === 'date') events[i][k] = e.target.value;
      else if (p !== undefined) events[i].periods[p] = e.target.checked ? 1 : 0;
      renderPages(); renderEvents();
    };
    if (el.tagName === 'BUTTON' && el.dataset.del !== undefined) {
      el.onclick = () => { events.splice(+el.dataset.del, 1); renderEvents(); renderPages(); };
    }
  });

  // --- Add Event Button ---
  document.getElementById('addEventBtn').onclick = () => {
    events.push({
      name: 'New Event',
      date: new Date().toISOString().slice(0, 10),
      periods: [0, 0, 0, 0, 0, 0]
    });
    renderEvents();
  };
}


/* ===== PRINT CONTROLS ===== */
function renderPrintControls(){
  const host=document.getElementById('printControls'); host.innerHTML='';
  termConfig.forEach((t,i)=>{
    const lbl=document.createElement('label');
    lbl.innerHTML=`<input type="checkbox" ${termInclude[i]?'checked':''}> Include Term ${t.term}`;
    const cb=lbl.querySelector('input');
    cb.onchange=e=>{termInclude[i]=e.target.checked; renderPages();};
    host.appendChild(lbl);
  });
}

/* ===== INIT ===== */
function init(){
  renderSubjectsTable();
  rebuildSubjects();
  renderGrid();
  renderEvents();
  renderPrintControls();
  renderPages();
  document.getElementById('printBtn').onclick=()=>window.print();
  const ep=document.getElementById('extraPages'); ep.value=extraPages;
  ep.onchange=e=>{extraPages=parseInt(e.target.value,10)||0; renderPages();};
}
/* ===== SAVE / LOAD PLANNER ===== */
function savePlanner() {
  let csv = 'TYPE,ROW,COL,VALUE\n';

  // Subjects and rooms
  subjCols.forEach((col, i) => {
    csv += `SUBJECT,${i},,${col.subject}\n`;
    col.rooms.forEach((r, j) => {
      csv += `ROOM,${i},${j},${r}\n`;
    });
  });

  // Duties
  dutyTextP2.forEach((d, i) => csv += `DUTY_P2,${i},,${d}\n`);
  dutyTextP4.forEach((d, i) => csv += `DUTY_P4,${i},,${d}\n`);

  // Timetable (subjects and rooms)
  gridSub.forEach((row, r) => {
    row.forEach((s, c) => {
      csv += `GRID_SUB,${r},${c},${s}\n`;
      csv += `GRID_ROOM,${r},${c},${gridRoom[r][c]}\n`;
    });
  });

  // --- Force download or show fallback ---
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.style.display = 'none';
  a.href = url;
  a.download = 'planner.csv';
  document.body.appendChild(a);

  try {
    // Give browser a tick before simulating click
    setTimeout(() => {
      a.click();
      alert('‚úÖ Planner saved.\nCheck your browser‚Äôs Downloads folder for "planner.csv".');
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 200);
  } catch (err) {
    console.warn('Auto-download blocked. Showing CSV manually.');
    const w = window.open();
    w.document.write('<pre>' + csv.replace(/</g, '&lt;') + '</pre>');
    w.document.title = 'Planner CSV Preview';
    alert('‚ö†Ô∏è Auto-download was blocked ‚Äî CSV opened in a new tab.\nUse "Save As" to download manually.');
  }
}

function loadPlannerFromCSV(text) {
  const lines = text.trim().split('\n').map(l => l.split(','));
  lines.forEach(line => {
    const [type, r, c, ...rest] = line;
    const value = rest.join(',');
    switch (type) {
      case 'SUBJECT':
        if (subjCols[r]) subjCols[r].subject = value;
        break;
      case 'ROOM':
        if (subjCols[r]) {
          if (!subjCols[r].rooms[c]) subjCols[r].rooms[c] = '';
          subjCols[r].rooms[c] = value;
        }
        break;
      case 'DUTY_P2':
        if (dutyTextP2[r] !== undefined) dutyTextP2[r] = value;
        break;
      case 'DUTY_P4':
        if (dutyTextP4[r] !== undefined) dutyTextP4[r] = value;
        break;
      case 'GRID_SUB':
        if (gridSub[r]) gridSub[r][c] = value;
        break;
      case 'GRID_ROOM':
        if (gridRoom[r]) gridRoom[r][c] = value;
        break;
    }
  });

  rebuildSubjects();
  renderSubjectsTable();
  renderGrid();
  renderPages();
  alert('‚úÖ Planner loaded successfully!');
}

function loadPlanner() {
  const input = document.getElementById('loadFile');
  input.value = ''; // reset so same file can be reloaded
  input.click();
}

/* Attach handlers after DOM fully loaded */
window.onload = function() {
  init(); // build planner first

  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const loadFile = document.getElementById('loadFile');

  if (saveBtn) saveBtn.addEventListener('click', savePlanner);
  if (loadBtn) loadBtn.addEventListener('click', loadPlanner);

  if (loadFile) {
    loadFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => loadPlannerFromCSV(ev.target.result);
      reader.readAsText(file);
    });
  }
};

init();
</script>
</body>

</html>
